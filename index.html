<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.css" integrity="sha384-yFRtMMDnQtDRO8rLpMIKrtPCD5jdktao2TV19YiZYWMDkUR5GQZR/NOVTdquEx1j" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.js" integrity="sha384-9Nhn55MVVN0/4OFx7EE5kpFBPsEMZxKTCnA+4fqDmg12eCTqGi6+BB2LjY8brQxJ" crossorigin="anonymous"></script>
<link rel='stylesheet' href='stylesheet_2018-05-16.css' type='text/css'/>

<!--
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="js_spectralsequences/w2ui-1.5.rc1.min.css" />
    <script type="text/javascript" src="js_spectralsequences/w2ui-1.5.rc1.min.js"></script>
-->
<style>
html, body {
  height: 98.5%;
  min-height: 98.5%;
}

#main {
        height: 100%;
        min-height: 100%;
}

#main-svg {
        width: 100%;
        height: 96%;
}

div.tooltip {	
    position: absolute;
    text-align: center;
    padding: 5px;
    font: 12px sans-serif;		
    background: lightsteelblue;
    border: 0px;
    border-radius: 8px;
    pointer-events: none;
}
.class {
    pointer-events: fill;
}

hr { height:2px; visibility:hidden; margin-bottom:-1px; }
</style>
</head>
<body>
<!--<script src="example_dir.php"></script> -->
<script src="js_spectralsequences/bundle.js" type="text/javascript"></script>
<!-- --
<script type="text/javascript" src='Cemsdk/CSteenrod.js'></script>
<script type="text/javascript" src='Cemsdk/CSteenrodWrappers.js'></script>
<script type="text/javascript" src='Cemsdk/ResolutionWorker.js'></script> -->
<!-- -->
<script>
katex_macros = {};
function katexMathInDelims(string){
    html_list = string.split(/(?:\\\[)|(?:\\\()|(?:\\\))|(?:\\\])|(?:\$)/);
    for(let i = 1; i < html_list.length; i+=2){
        html_list[i] = katex.renderToString(html_list[i], {macros : katex_macros});
    }
    return html_list.join("");
}

function groupBy(xs, key) {
  return xs.reduce(function(rv, x) {
    (rv[x[key]] = rv[x[key]] || []).push(x);
    return rv;
  }, {});
};

function URLHashToDictionary(url_hash){
    if(!url_hash){
        return undefined;
    }
    kv={};
    url_hash.slice(1).split("&").map((s) => s.split("=")).forEach(([k,v])=>kv[k]=v);
    return kv;
}

function URLHashFromDictionary(dictionary){
    return "#" + Object.entries(dictionary).map(([k,v]) =>`${k}=${v}`).join("&");
}

let url = new URL(document.location);
jsFile = URLHashToDictionary(url.hash);
if(jsFile){
    startResolution(jsFile);
} else {
    IO.loadFromServer("modules/module_registry.json").then((json) => {
        module_groups = groupBy(json, "p");
        let heading = document.createElement("h1");
        heading.innerHTML = "Spectral Sequences";
        let table = document.createElement("table");
        max_rows = Math.max(...Object.values(module_groups).map(x => x.length));
        table_rows = [];
        for(let i = 0; i < max_rows; i++){
            let tr = document.createElement("tr");
            tr.id = `row${i}`;
            table.appendChild(tr);
            table_rows.push(tr);
        }
        for(let [p, modules] of Object.entries(module_groups)){
            let i = -1;
            for(let module of modules){
                i++;
                let tdA = document.createElement("td");
                tdA.style.width = "150px"
                tdA.className = "module_${p}";
                // let tdB = document.createElement("td");
                // tdB.className = "description";
                let a = document.createElement("a");
                let dictionary = {"module" : module.file_name, "degree" : 50};
                a.href = URLHashFromDictionary(dictionary);
                a.onclick = () => startResolution(dictionary);
                a.innerHTML = katexMathInDelims(module["name"]);
                tdA.appendChild(a);
                // tdB.innerHTML = module['description'];
                table_rows[i].appendChild(tdA);
                // if(module['description']){
                //     tr.appendChild(tdB);
                // }       
            }
        }
        document.body.appendChild(heading);    
        document.body.appendChild(table);
    })
}

function startResolution(dict){
    main_div = document.createElement("div");
    main_div.id = "main";
    document.body.prepend(main_div);
    let degree = Number.parseInt(dict.degree);
    let module_file_name = dict.module;
    let sseq = new Sseq();
    sseq.xRange = [0, degree];
    sseq.yRange = [0, degree/3];
    sseq.initialxRange = [0, degree-3];
    sseq.initialyRange = [0, degree/3-1];
    sseq.display();
    let classTable = Array(degree).fill(0).map(x => Array(degree).fill(0).map(x => []));
    Mousetrap.unbind("left");
    Mousetrap.unbind("right");
    document.getElementById('page_indicator').innerText = "";    
    w = new Worker("Cemsdk/ResolutionWorker.js");
    w.addEventListener("message", (message)=>{
        let m = message.data;
        if(m.cmd == "addClass"){
            let c = sseq.addClass(m.x, m.y);
            sseq.update();
            classTable[m.x][m.y].push(c);
        } else {
            sseq.addStructline(classTable[m.source.x][m.source.y][m.source.idx], classTable[m.target.x][m.target.y][m.target.idx]);
        }
    })    
    IO.loadFromServer(`modules/${module_file_name}.json`).then((module) => {
        console.log(module);
        document.getElementById('page_indicator').innerHTML = katexMathInDelims(module.name);
        w.postMessage({
            "module" : module,
            "max_degree" : degree
        });
    });
}
</script> <!---->

</body>
</html> 